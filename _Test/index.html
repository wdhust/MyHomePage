<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Read/Write file test</title>
    <script>
        //
        // Functions
        //
        const getFileInfo = (inputFileElemId) => {
            const files = document.getElementById(inputFileElemId).files;
            if (files.length <= 0) {
                return null;
            }
            return files[0];
        }

        const writeTextFileAndDownload = (fileName, textContent) => {
            const blob = new Blob([textContent], { type: 'text/csv' });
            if (window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveBlob(blob, fileName);
            }
            else {
                const elem = document.createElement('a');
                elem.href = window.URL.createObjectURL(blob);
                elem.download = fileName;
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
            }
        }

        const convertTextContent = (inputText) => {
            let outputText = "";
            const repeatCount = 1000*1000*1;
            for (let i = 0; i < repeatCount; i++) {
                outputText += inputText + "+\n";
            }
            return outputText;
        }

        //
        // Event handlers
        //
        const onConvertTextFile = () => {
            var inputFileInfo = getFileInfo("inputFile");
            if (inputFileInfo == null) {
                console.log("Input file not found!");
                return;
            }

            var reader = new FileReader();
            reader.onload = (event) => {
                const textContent = event.target.result;
                console.log(`Input file contents: \n${textContent}`);

                const resultTextContent = convertTextContent(textContent);

                const resultFileName = "resultFile.txt";
                writeTextFileAndDownload(resultFileName, resultTextContent);
            };
            reader.onerror = (event) => {
                console.error(`File could not be read! Error code ${event.target.error.code}`);
            };
            reader.readAsText(inputFileInfo);
        }

        //
        //
        //
        const readUploadedFileAsText = (inputFile) => {
            const fileReader = new FileReader();

            return new Promise((resolve, reject) => {
                fileReader.onerror = () => {
                    fileReader.abort();
                    reject(new DOMException("Problem parsing input file."));
                };

                fileReader.onload = () => {
                    resolve(fileReader.result);
                };
                fileReader.readAsText(inputFile);
            });
        };

        const handleUpload = async (event) => {
            const file = event.target.files[0];
            const fileContentDiv = document.getElementById('file-content');
            if (!file) {
                fileContentDiv.innerHTML = "No file is selected!";
                return;
            }

            try {
                const fileContents = await readUploadedFileAsText(file);
                fileContentDiv.innerHTML = fileContents;
            } catch (e) {
                fileContentDiv.innerHTML = e.message;
            }
        }

        //document.getElementById('file-upload').addEventListener("change", handleUpload);
    </script>
</head>

<body>
    <section>
        <div>
            <p>Input text file:</p>
            <input type="file" id="inputFile" />
        </div>
    </section>
<section>
    <div>
        <button onclick="onConvertTextFile()">Convert and save</button>
    </div>
</section>
<section>
    <input id="file-upload" type="file" accept="text/plain" onchange="handleUpload(event)"/>
    <div id="file-content">
        Nothing uploaded yet
    </div>
</section>
</body>
</html>
